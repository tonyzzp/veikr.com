<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>Android音乐播放widget的简单事例(附源代码) - veikr的博客</title>
    <meta name="keywords" content="veikr的博客"/>
    <meta name="description" content=""/>
    <link rel="stylesheet" href="/css/bootstrap.min.css"/>
    <link rel="stylesheet" href="/css/prism.css"/>
    <link rel="stylesheet" href="/css/style.css"/>
</head>
<body class="post" data-perma="android_musicplayer_widget">
<header id="header">
    <div class="container">
        <div class="header clearfix">
            <nav id="site-nav">
                <ul class="nav nav-inverse nav-pills pull-right">
                    <li role="presentation" class="">
                        <a href="/" >文章
                        </a>
                    </li>
                    <li role="presentation" class="">
                        <a href="/archive" >归档
                        </a>
                    </li>
                </ul>
            </nav>
            <h3 id="site-title">
                <a href="/">veikr的博客 <sup>关于web、关于java、关于android</sup></a>
            </h3>
        </div>
    </div>
</header>

<section id="main">
    <div class="container">
        <div id="article-single">
            <article class="article">
                <div class="row">
                    <div class="col-md-10 col-md-offset-1 panel panel-default">
                        <header class="header">
                            <div class="meta">
                        <span class="date">
                            <span class="month">9</span>
                            <span class="day">3</span>
                        </span>
                            </div>
                            <h3 class="title">
                                <a href="/2011/9/3/android_musicplayer_widget.html">Android音乐播放widget的简单事例(附源代码)</a>
                            </h3>
                        </header>
                        <aside class="aside clearfix">
                            
                            <a class="tag label label-info" href="/tags/android.html">android</a>
                            
                            <a class="tag label label-info" href="/tags/appwidget.html">appwidget</a>
                            
                            <a class="tag label label-info" href="/tags/mediaplayer.html">mediaplayer</a>
                            
                            <a class="tag label label-info" href="/tags/service.html">service</a>
                            
                            <a class="tag label label-info" href="/tags/%e6%ba%90%e4%bb%a3%e7%a0%81.html">源代码</a>
                            
                            <a class="tag label label-info" href="/tags/%e9%9f%b3%e4%b9%90%e6%92%ad%e6%94%be.html">音乐播放</a>
                            
                            
                        </aside>
                        <section class="brief"><p>本文将做一个音乐播放的appWidget。通过本文您将学会：</p>

<p>1.制作简单的appWidget</p>

<p>2.service、broadcast</p>

<p>3.service与appWidget的交互</p>

<p>4.通过第三方库来读取mp3文件的id3标签(歌曲名、歌手名、专辑名等)</p>

<p><a href="http://veikr.com/wp-content/uploads/2011/09/musicWidget.png"><img class="aligncenter size-full wp-image-238" title="音乐播放器的AppWidget" src="http://veikr.com/wp-content/uploads/2011/09/device.png" alt="音乐播放器的AppWidget效果图" width="480" height="230" /></a></p>

<p><!--more-->开始工作吧。</p>

<p>一、widget的layout文件</p>

<p>普通的layout文件，同样存入在layout文件夹下
<pre class="brush:xml">&lt;?xml version=&ldquo;1.0&rdquo; encoding=&ldquo;utf-8&rdquo;?&gt;
&lt;RelativeLayout xmlns:android=&ldquo;<a href="http://schemas.android.com/apk/res/android&quot;">http://schemas.android.com/apk/res/android&quot;</a>
    android:layout_width=&ldquo;fill_parent&rdquo; android:layout_height=&ldquo;fill_parent&rdquo;
    android:orientation=&ldquo;vertical&rdquo;&gt;
    &lt;TextView android:text=&ldquo;TextView&rdquo; android:id=&ldquo;@+id/textView1&rdquo;
        android:textSize=&ldquo;25px&rdquo; android:layout_height=&ldquo;wrap_content&rdquo;
        android:layout_width=&ldquo;match_parent&rdquo; android:gravity=&ldquo;center&rdquo;&gt;&lt;/TextView&gt;
    &lt;LinearLayout android:id=&ldquo;@+id/linearLayout1&rdquo;
        android:layout_height=&ldquo;wrap_content&rdquo; android:layout_width=&ldquo;match_parent&rdquo;
        android:layout_below=&ldquo;@id/textView1&rdquo; android:gravity=&ldquo;center&rdquo;&gt;
        &lt;ImageView android:src=&ldquo;@drawable/previous&rdquo;
            android:layout_height=&ldquo;wrap_content&rdquo; android:layout_width=&ldquo;wrap_content&rdquo;
            android:layout_weight=&ldquo;1.0&rdquo; android:id=&ldquo;@+id/previous&rdquo; /&gt;
        &lt;ImageView android:src=&ldquo;@drawable/play&rdquo;
            android:layout_height=&ldquo;wrap_content&rdquo; android:layout_width=&ldquo;wrap_content&rdquo;
            android:layout_weight=&ldquo;1.0&rdquo; android:id=&ldquo;@+id/play&rdquo; /&gt;
        &lt;ImageView android:src=&ldquo;@drawable/next&rdquo;
            android:layout_height=&ldquo;wrap_content&rdquo; android:layout_width=&ldquo;wrap_content&rdquo;
            android:layout_weight=&ldquo;1.0&rdquo; android:id=&ldquo;@+id/next&rdquo; /&gt;
    &lt;/LinearLayout&gt;
&lt;/RelativeLayout&gt;</pre>
二、widget的配置文件</p>

<p>右键-new-androi xml file，选择appWidget provider，输入文件名，即可。</p>

<p>此文件会存在于xml文件夹下
<pre class="brush:xml">&lt;?xml version=&ldquo;1.0&rdquo; encoding=&ldquo;utf-8&rdquo;?&gt;
&lt;appwidget-provider xmlns:android=&ldquo;<a href="http://schemas.android.com/apk/res/android&quot;">http://schemas.android.com/apk/res/android&quot;</a>
    android:minWidth=&ldquo;320px&rdquo; android:updatePeriodMillis=&ldquo;3600000&rdquo;
    android:initialLayout=&ldquo;@layout/widget&rdquo; android:minHeight=&ldquo;150px&rdquo;&gt;
&lt;/appwidget-provider&gt;</pre>
属性很简单， 就不用解释了</p>

<p>&nbsp;
三、写appWidgetProvider类，这个类实现widget的更新与事件监听
class MusicProvider extends AppWidgetProvider.
appwidgetprovider其实是broadcastreceiver的。
此类下的主要方法onReceive,onUpdate,onEnable,onDisable,onDeleted。
onEnable方法在第一个widget被添加到桌面时调用，我们在这里启动音乐播放服务(后面再写)
onDisable方法在全部widget删除后调用，我们在这里关闭服务
onUpdate方法里我们对widget的各控件设置监听
onReceiver方法其实就是broadCastReceiver里的onReceiver，在收到广播时我们更新widget(比如显示歌名)
<pre class="brush:java">package zzp.musicwidget;</p>

<p>import android.app.PendingIntent;
import android.appwidget.AppWidgetManager;
import android.appwidget.AppWidgetProvider;
import android.content.ComponentName;
import android.content.Context;
import android.content.Intent;
import android.widget.RemoteViews;
import zzp.musicwidget.R;</p>

<p>public class MusicWidgetProvider extends AppWidgetProvider {</p>

<p>@Override
public void onReceive(Context context, Intent intent) {
super.onReceive(context, intent);
System.out.println(&ldquo;provider receive:&rdquo; + intent);
String action = intent.getAction();
RemoteViews views = new RemoteViews(context.getPackageName(),
R.layout.widget);
if (action.equals(&ldquo;zzp.musicwidget.widget.play&rdquo;)) {
views.setImageViewResource(R.id.play, R.drawable.pause);
} else if (action.equals(&ldquo;zzp.musicwidget.widget.pause&rdquo;)) {
views.setImageViewResource(R.id.play, R.drawable.play);
} else if (action.equals(&ldquo;zzp.musicwidget.widget.title&rdquo;)) {
views.setTextViewText(R.id.textView1,
intent.getStringExtra(Intent.EXTRA_TEXT));
}</p>

<p>// 改变完成后，请一定要记住调用updateAppWidget方法，否则改变不会生效
AppWidgetManager mgr = AppWidgetManager.getInstance(context);
mgr.updateAppWidget(new ComponentName(context,
MusicWidgetProvider.class), views);
}</p>

<p>@Override
public void onUpdate(Context context, AppWidgetManager appWidgetManager,
int[] appWidgetIds) {
super.onUpdate(context, appWidgetManager, appWidgetIds);</p>

<p>// 在这里给widget里的控件添加监听事件
RemoteViews views = new RemoteViews(context.getPackageName(),
R.layout.widget);
Intent inext = new Intent(&ldquo;zzp.musicwidget.next&rdquo;);
PendingIntent pnext = PendingIntent.getBroadcast(context, 0, inext, 0);
Intent iprevious = new Intent(&ldquo;zzp.musicwidget.previous&rdquo;);
PendingIntent pprevious = PendingIntent.getBroadcast(context, 0,
iprevious, 0);
Intent iplay = new Intent(&ldquo;zzp.musicwidget.playorpause&rdquo;);
PendingIntent pplay = PendingIntent.getBroadcast(context, 0, iplay, 0);
views.setOnClickPendingIntent(R.id.next, pnext);
views.setOnClickPendingIntent(R.id.play, pplay);
views.setOnClickPendingIntent(R.id.previous, pprevious);
// 不要忘记updateAppWidget
AppWidgetManager mgr = AppWidgetManager.getInstance(context);
mgr.updateAppWidget(new ComponentName(context,
MusicWidgetProvider.class), views);
}</p>

<p>@Override
public void onEnabled(Context context) {
super.onEnabled(context);
Intent intent = new Intent(context, MusicService.class);
context.startService(intent);
}</p>

<p>@Override
public void onDisabled(Context context) {
// 当widget删除时，停止musicService
super.onDisabled(context);
Intent intent = new Intent(context, MusicService.class);
context.stopService(intent);
}
}</pre>
在onUpdate中对控件设置了监听，当点击按钮(播放、下一曲、上一曲)后发送广播。而我们的service中会接收这些广播，然后执行相应的操作。
service中的的某些操作(播放、暂停、换歌)执行后，也会发送广播，这时appWidgetProvider收到广播后调widget界面(显示歌名、变换图标)</p>

<p>&nbsp;
四、音乐播放的service
这个类中接收widgetProvider发送的广播，然后进行相关操作(播放、暂停、下一曲、上一曲)
<pre class="brush:java">package zzp.musicwidget;</p>

<p>import java.io.File;
import java.io.IOException;
import java.util.ArrayList;
import java.util.List;</p>

<p>import org.farng.mp3.MP3File;
import org.farng.mp3.TagException;
import org.farng.mp3.id3.AbstractID3v2;
import org.farng.mp3.id3.ID3v1;
import zzp.musicwidget.R;</p>

<p>import android.app.Service;
import android.content.BroadcastReceiver;
import android.content.Context;
import android.content.Intent;
import android.content.IntentFilter;
import android.media.MediaPlayer;
import android.os.IBinder;</p>

<p>public class MusicService extends Service {
private MediaPlayer player;
private List&lt;String&gt; data;
private int location = 0;
private BroadcastReceiver receiver;</p>

<p>@Override
public void onCreate() {
// TODO Auto-generated method stub
super.onCreate();
System.out.println(&ldquo;music service create&rdquo;);
}</p>

<p>@Override
public void onStart(Intent intent, int startId) {
super.onStart(intent, startId);
System.out.println(&ldquo;music service onbind&rdquo;);
player = new MediaPlayer();
data = new ArrayList&lt;String&gt;();
System.out.println(&ldquo;开始加载音乐&rdquo;);
File file = new File(&ldquo;/mnt/sdcard/veikrmusic&rdquo;);
File[] files = file.listFiles();
for (File f : files) {
if (f.isFile() &amp;&amp; f.getName().endsWith(&ldquo;.mp3&rdquo;)) {
data.add(f.getAbsolutePath());
}
}
System.out.println(&ldquo;音乐加载ok:&rdquo; + data.size());</p>

<p>try {
player.setDataSource(data.get(location));
player.prepare();
} catch (IllegalArgumentException e1) {
// TODO Auto-generated catch block
e1.printStackTrace();
} catch (IllegalStateException e1) {
// TODO Auto-generated catch block
e1.printStackTrace();
} catch (IOException e1) {
// TODO Auto-generated catch block
e1.printStackTrace();
}
receiver = new BroadcastReceiver() {
@Override
public void onReceive(Context context, Intent intent) {
System.out.println(&ldquo;service receive:&rdquo; + intent);
String action = intent.getAction();
if (action.equals(&ldquo;zzp.musicwidget.playorpause&rdquo;)) {
if (!player.isPlaying()) {
try {
player.start();
sendPlay();
} catch (IllegalStateException e) {
// TODO Auto-generated catch block
e.printStackTrace();
}
} else {
player.pause();
sendPause();
}
} else if (action.equals(&ldquo;zzp.musicwidget.next&rdquo;)) {
playNext();
} else if (action.equals(&ldquo;zzp.musicwidget.previous&rdquo;)) {
playPrevious();
}
}
};</p>

<p>IntentFilter filter = new IntentFilter();
filter.addAction(&ldquo;zzp.musicwidget.next&rdquo;);
filter.addAction(&ldquo;zzp.musicwidget.playorpause&rdquo;);
filter.addAction(&ldquo;zzp.musicwidget.previous&rdquo;);
registerReceiver(receiver, filter);
}</p>

<p>public void playNext() {
if (location &lt; data.size() - 1) {
location++;
} else if (location == data.size() - 1) {
location = 0;
}
play();
}</p>

<p>public void playPrevious() {
if (location == 0) {
location = data.size() - 1;
} else if (location &gt; 0) {
location--;
}
play();
}</p>

<p>public void play() {
System.out.println(&ldquo;播放第&rdquo; + location + &ldquo;首&rdquo;);
try {
// player.release();
// player = null;
// player = new MediaPlayer();
player.reset();
player.setDataSource(data.get(location));
player.prepare();
player.start();
sendPlay();
} catch (IllegalArgumentException e) {
// TODO Auto-generated catch block
e.printStackTrace();
} catch (IllegalStateException e) {
// TODO Auto-generated catch block
e.printStackTrace();
} catch (IOException e) {
// TODO Auto-generated catch block
e.printStackTrace();
}
}</p>

<p>@Override
public void onDestroy() {
unregisterReceiver(receiver);
super.onDestroy();
}</p>

<p>@Override
public IBinder onBind(Intent intent) {
return null;
}</p>

<p>/**
* 发送播放通知，以便widget改变图标样式
*/
public void sendPlay() {
Intent play = new Intent(&ldquo;zzp.musicwidget.widget.play&rdquo;);
sendBroadcast(play);
try {
sendTitle();
} catch (Exception e) {</p>

<p>}
}</p>

<p>public void sendPause() {
Intent play = new Intent(&ldquo;zzp.musicwidget.widget.pause&rdquo;);
sendBroadcast(play);
}</p>

<p>/**
* 发送歌曲标题到widget
*/
public void sendTitle() {
String filepath = data.get(location);
System.out.println(filepath);
MP3File mp3 = null;
try {
mp3 = new MP3File(filepath);
} catch (IOException e) {
// TODO Auto-generated catch block
e.printStackTrace();
} catch (TagException e) {
// TODO Auto-generated catch block
e.printStackTrace();
}
AbstractID3v2 id3v2 = mp3.getID3v2Tag();
ID3v1 id3v1 = null;
if (id3v2 == null) {
id3v1 = mp3.getID3v1Tag();
}
String title = &ldquo;&rdquo;;
if (id3v2 != null) {
title = id3v2.getLeadArtist() + &ldquo; - &rdquo; + id3v2.getSongTitle();
} else if (id3v1 != null) {
title = id3v1.getLeadArtist() + &ldquo; - &rdquo; + id3v1.getSongTitle();
}
Intent i = new Intent(&ldquo;zzp.musicwidget.widget.title&rdquo;);
i.putExtra(Intent.EXTRA_TEXT, title);
sendBroadcast(i);
}
}</pre>
onStart中初始化音乐(音乐文件放在/sdcard/veikrmusic目录下，必须为mp3)，注册广播接收器，以便接收widget发送的命令
接收到widget发送的广播后进行相关操作，操作完成后再发送广播通知widget更新界面
这里面用到了一个第三方库来解析mp3文件的id3标签，文章末尾附下载</p>

<p>&nbsp;</p>

<p>五、代码都写好了，剩下的就是配置了
<pre class="brush:xml">&lt;?xml version=&ldquo;1.0&rdquo; encoding=&ldquo;utf-8&rdquo;?&gt;
&lt;manifest xmlns:android=&ldquo;<a href="http://schemas.android.com/apk/res/android&quot;">http://schemas.android.com/apk/res/android&quot;</a>
package=&ldquo;zzp.musicwidget&rdquo; android:versionCode=&ldquo;1&rdquo; android:versionName=&ldquo;1.0&rdquo;&gt;
&lt;uses-sdk android:minSdkVersion=&ldquo;7&rdquo; /&gt;
&lt;uses-permission android:name=&ldquo;android.permission.WRITE_EXTERNAL_STORAGE&rdquo;&gt;&lt;/uses-permission&gt;
&lt;application android:icon=&ldquo;@drawable/icon&rdquo; android:label=&ldquo;@string/app_name&rdquo;&gt;
&lt;receiver android:name=&ldquo;MusicWidgetProvider&rdquo;&gt;
&lt;intent-filter&gt;
&lt;action android:name=&ldquo;android.appwidget.action.APPWIDGET_UPDATE&rdquo;&gt;&lt;/action&gt;
&lt;action android:name=&ldquo;zzp.musicwidget.widget.play&rdquo;&gt;&lt;/action&gt;
&lt;action android:name=&ldquo;zzp.musicwidget.widget.pause&rdquo;&gt;&lt;/action&gt;
&lt;action android:name=&ldquo;zzp.musicwidget.widget.title&rdquo;&gt;&lt;/action&gt;
&lt;/intent-filter&gt;
&lt;meta-data android:resource=&ldquo;@xml/widget&rdquo; android:name=&ldquo;android.appwidget.provider&rdquo;&gt;&lt;/meta-data&gt;
&lt;/receiver&gt;
&lt;service android:name=&ldquo;MusicService&rdquo;&gt;&lt;/service&gt;
&lt;/application&gt;
&lt;/manifest&gt;</pre>
OK！大功告成
算不上什么教程，都是在粘源代码，大家都指教，高手莫笑。</p>

<p>ps:好几个月没写博客了
前几天刚刚换了个空间，原来那个太太太垃圾了。速度慢的要命，三天两头上不去，客服垃圾，挤一句说一句。。
经常改IP，也不通知你，等网站上不去了再问客服，他们才说换IP了。。。
另外，本来有phpAdmin的，后来突然就没了。。。冰山互联。。。大家一定一定不要用！！！！</p>

<p>下载：</p>

<p><a href="http://veikr.com/wp-content/uploads/2011/09/MusicWidget.apk_.zip">MusicWidget.apk 安装包</a></p>

<p><a href="http://veikr.com/wp-content/uploads/2011/09/MusicWidget.zip">MusicWidget.zip 源码</a></p>
</section>
                    </div>
                </div>
            </article>
        </div>
        
<section id="comment">
    
    
</section>

    </div>
</section>
<footer id="footer">
    <div class="container text-center">
        <p>© 2015 veikr的博客.
            <a href="http://creativecommons.org/licenses/by/3.0/">Some rights reserved </a> |
            <a href="/feed.xml">Feed</a> |
            <a href="/sitemap.xml">Sitemap</a>
        </p>
        <p>Powered by <a href="https://github.com/go-xiaohei/pugo">PuGo 0.10.5 (beta)</a>. Theme by Default.
        </p>
        
    
    

    </div>
</footer>
<script src="/js/jquery-2.1.4.min.js"></script>
<script src="/js/bootstrap.min.js"></script>
<script src="/js/prism.min.js"></script>
<script>
    $(document).ready(function () {
        $("pre code").addClass("line-numbers")
    });
</script>
</body>
</html>
