<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>libgdx中异步从网络加载图片 - veikr的博客</title>
    <meta name="keywords" content="veikr的博客"/>
    <meta name="description" content=""/>
    <link rel="stylesheet" href="/css/bootstrap.min.css"/>
    <link rel="stylesheet" href="/css/prism.css"/>
    <link rel="stylesheet" href="/css/style.css"/>
</head>
<body class="post" data-perma="libgdx_load_texture_network_async">
<header id="header">
    <div class="container">
        <div class="header clearfix">
            <nav id="site-nav">
                <ul class="nav nav-inverse nav-pills pull-right">
                    <li role="presentation" class="">
                        <a href="/" >文章
                        </a>
                    </li>
                    <li role="presentation" class="">
                        <a href="/archive" >归档
                        </a>
                    </li>
                </ul>
            </nav>
            <h3 id="site-title">
                <a href="/">veikr的博客 <sup>关于web、关于java、关于android</sup></a>
            </h3>
        </div>
    </div>
</header>

<section id="main">
    <div class="container">
        <div id="article-single">
            <article class="article">
                <div class="row">
                    <div class="col-md-10 col-md-offset-1 panel panel-default">
                        <header class="header">
                            <div class="meta">
                        <span class="date">
                            <span class="month">3</span>
                            <span class="day">30</span>
                        </span>
                            </div>
                            <h3 class="title">
                                <a href="/2012/3/30/libgdx_load_texture_network_async.html">libgdx中异步从网络加载图片</a>
                            </h3>
                        </header>
                        <aside class="aside clearfix">
                            
                            <a class="tag label label-info" href="/tags/android.html">android</a>
                            
                            <a class="tag label label-info" href="/tags/libgdx.html">libgdx</a>
                            
                            <a class="tag label label-info" href="/tags/texture.html">texture</a>
                            
                            <a class="tag label label-info" href="/tags/%e6%b8%b8%e6%88%8f.html">游戏</a>
                            
                            <a class="tag label label-info" href="/tags/%e7%bd%91%e7%bb%9c.html">网络</a>
                            
                            
                        </aside>
                        <section class="brief"><p>使用libgdx从网络中下载图片，并转换为texture画出来。其实并不复杂，只需要四步就可以了。</p>

<p>1、从网络中读取图片数据到byte[]</p>

<p>2、使用byte[]生成一个pixmap</p>

<p>3、将pixmap画到一张边长是2的N次幂的texture上</p>

<p>4、从texture构造textureRegion</p>

<!--more-->

<p>大概代码如下：</p>

<p><span style="color: #339966;">一、从url读取byte[]</span>
<pre class="brush:java">InputStream is=new URL(surl).openStream();
ByteArrayOutputStream out = new ByteArrayOutputStream();
int length = 0;
byte[] bytes = new byte[1024];
while ((length = is.read(bytes)) != -1) {
    out.write(bytes, 0, length);
}
is.close();
out.flush();
byte[] rtn = out.toByteArray();</pre>
<span style="color: #339966;">二、使用byte[]生成一个pixmap</span>
<pre class="brush:java">Pixmap pixmap = new Pixmap(bytes, 0, bytes.length);</pre>
<span style="color: #339966;">三、将pixmap画到texture上</span>
<pre class="brush:java">int width = pixmap.getWidth();
int height = pixmap.getHeight();
int preferWidth = MathUtils.nextPowerOfTwo(width);
int preferHeight = MathUtils.nextPowerOfTwo(height);
Texture texture = new Texture(preferWidth,preferHeight,pixmap.getFormat());
texture.draw(pixmap, 0, 0);
pixmap.dispose();</pre>
<span style="color: #339966;">四、构造textureRegion</span></p>

<p>&nbsp;
<pre class="brush:java">TextureRegion region=new TextureRegioin(texture,0,0,width,heigth);</pre>
大功告成！</p>

<p>&nbsp;</p>

<p><span style="color: #ff0000;">但是，这里有一些小问题需要注意的。</span></p>

<p>1、new Texture()这类方法必须放到绘制线程，但读取网络数据流你肯定不能放到绘制线程。</p>

<p>所以可行的办法是新启线程读取数据流，然后使用Gdx.app.postRunnable(new Runnable())来将构造texture的操作post到绘制线程去完成。</p>

<p>&nbsp;</p>

<p>2、另外一个小技巧，你肯定会想写一个工具类来从网络加载texture，但因为是异步的，所以是不能使用返回值的方式传回texture的。</p>

<p>所以必须这样。</p>

<p>&nbsp;
<pre class="brush:java">
TextureRegion region=new TextureRegion(new Texture(1,1,Format.RGBA8888));
loadTextureRegionFromUrl(region,&ldquo;<a href="http://sss.com/asdf.png&quot;">http://sss.com/asdf.png&quot;</a>);</p>

<p>public static void loadTextureRegionFromUrl(final TextureRegion region,
            final String url) {
if (region == null) {
    throw new NullPointerException(&ldquo;region不能为空&rdquo;);
}
new Thread() {
    @Override
    public void run() {
        try {
            final byte[] bytes = ReaderHelper.getBytesFromUrl(url);
            System.out.println(url + &ldquo; 图片获取成功：&rdquo; + bytes.length);
            Gdx.app.postRunnable(new Runnable() {
                @Override
                public void run() {
                    Pixmap pixmap = new Pixmap(bytes, 0, bytes.length);
                    int width = pixmap.getWidth();
                    int height = pixmap.getHeight();
                    int preferWidth = MathUtils.nextPowerOfTwo(width);
                    int preferHeight = MathUtils.nextPowerOfTwo(height);
                    Texture texture = new Texture(preferWidth,
                            preferHeight, pixmap.getFormat());
                    texture.draw(pixmap, 0, 0);
                    pixmap.dispose();
                    region.setTexture(texture);
                    region.setRegion(0, 0, width, height);
                    System.out.println(region.getRegionWidth());
                    System.out.println(region.getRegionHeight());
                    System.out.println(region.getTexture().getHeight());
                }
            });
        } catch (MalformedURLException e) {
            e.printStackTrace();
        } catch (IOException e) {
            e.printStackTrace();
        }
    };
}.start();
}</pre>
&nbsp;</p>

<p>最后还有要注意的，<span style="color: #ff9900;">libgdx只支持jpb,png,bmp格式图片，gif什么的就不行了。</span></p>
</section>
                    </div>
                </div>
            </article>
        </div>
        
<section id="comment">
    
    
</section>

    </div>
</section>
<footer id="footer">
    <div class="container text-center">
        <p>© 2015 veikr的博客.
            <a href="http://creativecommons.org/licenses/by/3.0/" target="_blank">Some rights reserved </a> |
            <a href="/feed.xml" target="_blank">Feed</a> |
            <a href="/sitemap.xml" target="_blank">Sitemap</a>
        </p>
        <p>Powered by <a href="https://github.com/go-xiaohei/pugo" target="_blank">PuGo 0.10.5 (beta)</a>. Theme by Default.
        </p>
        <p>Hosted by <a href="https://pages.coding.me" style="font-weight: bold" target="_blank">Coding Pages</a></p>
        
    
    

    </div>
</footer>
<script src="/js/jquery-2.1.4.min.js"></script>
<script src="/js/bootstrap.min.js"></script>
<script src="/js/prism.min.js"></script>
<script>
    $(document).ready(function () {
        $("pre code").addClass("line-numbers")
    });
</script>
</body>
</html>
