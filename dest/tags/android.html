<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>android - veikr的博客</title>
    <meta name="keywords" content="veikr的博客"/>
    <meta name="description" content="veikr的博客"/>
    <link rel="stylesheet" href="/css/bootstrap.min.css"/>
    <link rel="stylesheet" href="/css/prism.css"/>
    <link rel="stylesheet" href="/css/style.css"/>
</head>
<body class="post-tag" data-perma="post-tag-android">
<header id="header">
    <div class="container">
        <div class="header clearfix">
            <nav id="site-nav">
                <ul class="nav nav-inverse nav-pills pull-right">
                    <li role="presentation" class="">
                        <a href="/" >文章
                        </a>
                    </li>
                    <li role="presentation" class="">
                        <a href="/archive" >归档
                        </a>
                    </li>
                </ul>
            </nav>
            <h3 id="site-title">
                <a href="/">veikr的博客 <sup>关于web、关于java、关于android</sup></a>
            </h3>
        </div>
    </div>
</header>

<section id="main">
    <div class="container">
        <div id="article-list">
            <h2 class="tag text-center">android</h2>
            <article class="article">
                <div class="row">
                    <div class="col-md-10 col-md-offset-1 panel panel-default">
                        <header class="header">
                            <div class="meta">
                        <span class="date">
                            <span class="month">6</span>
                            <span class="day">10</span>
                        </span>
                            </div>
                            <h3 class="title">
                                <a href="/2012/6/10/android_service.html">android中service的简单实现</a>
                            </h3>
                        </header>
                        <section class="brief"><p>简单介绍下android中service的用法，其实我也没太研究明白，只是拿出来分享一下。</p>

<p>废话不多说，直接上代码比较好。</p>

<p>一、首先你需要有个类，继承自service。
<pre class="brush:java">package zzp.test.service;</p>

<p>import android.app.Service;
import android.content.Intent;
import android.os.Binder;
import android.os.IBinder;</p>

<p>public class PushService extends Service {</p>
<pre><code>public class PushBinder extends Binder {
    public void downLoadFile(final String url) {
        new Thread() {
            @Override
            public void run() {
                super.run();
                System.out.println(&quot;开始下载:&quot; + url);
                try {
                    Thread.sleep(5000);
                } catch (InterruptedException e) {
                    e.printStackTrace();
                }
                System.out.println(&quot;下载完成&quot;);
            }
        }.start();
    }
}

private final PushBinder binder = new PushBinder();

@Override
public IBinder onBind(Intent arg0) {
    // TODO Auto-generated method stub
    System.out.println(&quot;onBind&quot;);
    return binder;
}

@Override
public void onCreate() {
    // TODO Auto-generated method stub
    super.onCreate();
    System.out.println(&quot;onCreate&quot;);
}

@Override
public void onDestroy() {
    // TODO Auto-generated method stub
    super.onDestroy();
    System.out.println(&quot;onDestroy&quot;);
}

@Override
public void onRebind(Intent intent) {
    // TODO Auto-generated method stub
    super.onRebind(intent);
    System.out.println(&quot;onRebind&quot;);
}

@Override
public void onStart(Intent intent, int startId) {
    // TODO Auto-generated method stub
    super.onStart(intent, startId);
    System.out.println(&quot;onStart:&quot; + startId);
}

@Override
public boolean onUnbind(Intent intent) {
    // TODO Auto-generated method stub
    System.out.println(&quot;onUnbind&quot;);
    return super.onUnbind(intent);
}
</code></pre>

<p>}</pre>
onCreate:在服务首次创建时调用。</p>

<p>onDestroy:在服务被销毁时调用。</p>

<p>onStart:当使用startService时调用此方法，如果是第一次调用，则会先调用onCreate来创建服务。在服务已经启动的情况下，每次使用startService方法都会调用onStart方法，但服务只会有一个，不会产生多个。(现已改为onStartCommand，onStart不再建议使用)。</p>

<p>onBind:使用bindService时调用此方法,返回一个IBinder，用来与服务进行交互。</p>

<p>onUnBind:使用unbindService时调用。unbindService只能在服务已经绑定状态才会能调用，否则将会抛异常。在一个activity中绑定了service,当activity退出时必须unbindService，否则也会有异常。</p>

<p>&nbsp;</p>

<p>主要就这几个方法了，这里简单说下service的生命周期。</p>

<p>1、当第一次调用startService或bindService(加入BIND_AUTO_CREATE  flag)时，服务会被创建，onCreate方法被调用。</p>

<p>2、每一次使用startService时onStart方法都会被调用，多次使用bindService，onBind方法只会调用一次。</p>

<p>3、使用stopService会停止服务，onDestroy方法被调用。使用unbindService也会停止服务，onunBind和onDestroy会被调用。但这里有个前提：如果你同时用了startService和bindService，那你必须同时调用unBindService和stopService，服务才会真正被停止。</p>

<p>&nbsp;</p>

<p>在service中onBind方法返回一个IBinder，用此来与服务进行通信交互。所以服务的一般用法是，在activity中先startServie来启用服务，然后使用bindService来获得IBinder，与服务交互。activity退出时必须调用unBindService,但服务还不会停止，当你不再服务此服务时，调用stopService来停止服务。</p>

<p>&nbsp;
<pre class="brush:java">package zzp.test.service;</p>

<p>import zzp.test.service.PushService.PushBinder;
import android.app.Activity;
import android.content.ComponentName;
import android.content.Context;
import android.content.Intent;
import android.content.ServiceConnection;
import android.os.Bundle;
import android.os.IBinder;
import android.view.View;
import android.view.View.OnClickListener;
import android.widget.Button;</p>

<p>public class TestServiceActivity extends Activity implements OnClickListener {</p>
<pre><code>Button start, stop, bind, unbind, download;
ServiceConnection conn;
PushBinder push;
boolean binded = false;

/** Called when the activity is first created. */
@Override
public void onCreate(Bundle savedInstanceState) {
    super.onCreate(savedInstanceState);
    setContentView(R.layout.main);

    start = (Button) findViewById(R.id.start);
    stop = (Button) findViewById(R.id.stop);
    bind = (Button) findViewById(R.id.bind);
    unbind = (Button) findViewById(R.id.unbind);
    download = (Button) findViewById(R.id.download);

    start.setOnClickListener(this);
    stop.setOnClickListener(this);
    bind.setOnClickListener(this);
    unbind.setOnClickListener(this);
    download.setOnClickListener(this);
    conn = new ServiceConnection() {

        @Override
        public void onServiceConnected(ComponentName name, IBinder service) {
            // TODO Auto-generated method stub
            System.out.println(&quot;onServiceConnected&quot;);
            binded = true;
            print(name);
            print(service.getClass().getName());
            push = (PushBinder) service;
        }

        @Override
        public void onServiceDisconnected(ComponentName name) {
            // TODO Auto-generated method stub
            System.out.println(&quot;onServiceDisconnected&quot;);
            binded = false;
            print(name);
        }

    };
}

@Override
public void onClick(View v) {
    Intent intent = new Intent(this, PushService.class);
    switch (v.getId()) {
    case R.id.bind:
        boolean flag = bindService(intent, conn, Context.BIND_AUTO_CREATE);
        print(flag);
        break;
    case R.id.unbind:
        if (binded) {
            binded = false;
            unbindService(conn);
        }
        break;
    case R.id.start:
        startService(intent);
        break;
    case R.id.stop:
        stopService(intent);
        break;
    case R.id.download:
        push.downLoadFile(&quot;http://test.com/icon.png&quot;);
        break;
    }
}

@Override
protected void onPause() {
    // TODO Auto-generated method stub
    super.onPause();
    if (isFinishing() &amp;amp;&amp;amp; binded) {
        unbindService(conn);
        binded = false;
    }
}

private void print(Object o) {
    if (o == null) {
        System.out.println(&quot;null&quot;);
    } else {
        System.out.println(o);
    }
}
</code></pre>

<p>}</pre>
&nbsp;</p>

<p>另外，你需要在manifest中配置一下服务，这一句话就够了。
<pre class="brush:xml">&lt;service android:name=&ldquo;PushService&rdquo;&gt;</pre>
&nbsp;</p>

<p>其实我还有些疑问，我这里的onServiceDisconnected从来没被调用过，onRebind也从来没被调用过，还不明白为什么，有知道的朋友麻烦指教一下。</p>

<p>&nbsp;</p>

<p><span style="color: #ff0000;">注</span>：可能有人遇到过一个类似的异常：</p>

<p>java.lang.ClassCastException: android.os.BinderProxy</p>

<p>在onServiceConnected中对返回的IBinder进行强制类型转换出出现这个异常。解决办法很简单，去掉manifest中service配置中的process属性。使用此属性会将service放到一个单独的线程中，但会出现强制类型转换异常。</p>
</section>
                        <aside class="aside clearfix">
                            <a class="btn btn-primary btn-lg pull-right" href="/2012/6/10/android_service.html">继续阅读</a>
                        </aside>
                    </div>
                </div>
            </article>
            
            <article class="article">
                <div class="row">
                    <div class="col-md-10 col-md-offset-1 panel panel-default">
                        <header class="header">
                            <div class="meta">
                        <span class="date">
                            <span class="month">3</span>
                            <span class="day">30</span>
                        </span>
                            </div>
                            <h3 class="title">
                                <a href="/2012/3/30/libgdx_load_texture_network_async.html">libgdx中异步从网络加载图片</a>
                            </h3>
                        </header>
                        <section class="brief"><p>使用libgdx从网络中下载图片，并转换为texture画出来。其实并不复杂，只需要四步就可以了。</p>

<p>1、从网络中读取图片数据到byte[]</p>

<p>2、使用byte[]生成一个pixmap</p>

<p>3、将pixmap画到一张边长是2的N次幂的texture上</p>

<p>4、从texture构造textureRegion</p>
</section>
                        <aside class="aside clearfix">
                            <a class="btn btn-primary btn-lg pull-right" href="/2012/3/30/libgdx_load_texture_network_async.html">继续阅读</a>
                        </aside>
                    </div>
                </div>
            </article>
            
            <article class="article">
                <div class="row">
                    <div class="col-md-10 col-md-offset-1 panel panel-default">
                        <header class="header">
                            <div class="meta">
                        <span class="date">
                            <span class="month">2</span>
                            <span class="day">21</span>
                        </span>
                            </div>
                            <h3 class="title">
                                <a href="/2012/2/21/resolve_apk_file_reource.html">读取apk程序包的内容</a>
                            </h3>
                        </header>
                        <section class="brief"><p>一、对于已安装应用，只需要getPackageManager().getInstalledPacked(int flags)即可得到PackageInfo.
<div>packageInfo.applicationInto中可以得到所有信息。</div>
<div>注：区别系统应用和用户应用：applicationInfo.flags &amp; ApplicationInfo.FLAG_SYSTEM</div>
<div></div>
<div>二、对于未安装应用(apk文件)</div>
<div>使用packageManager.getPackageArchiveInfo(String filePath,int flags)，只能得到部分信息。</div>
<div>所有int形式的资源(label,icon等)都是无法得到的，需要使用反射机制用到隐藏接口</div>
<div></div>
<div>方法如下：</div>
<div></div>
<div>
<pre class="brush:java">Resources res=getResources();
AssetManager asm=new AssetManager();//隐藏api
asm.addAssetPath(String apkfilePath);//隐藏api
res=new Resources(asm,res.getDisplayMetrics(),res.getConfiguration());//隐藏api</pre>
</div>
<div></div>
<div>然后使用res.getString(int resId)   res.getDrawable(int resId)即可得到apk文件内部的资源。(此处资源id可通过上面的公开方法得到)</div>
<div>关键点就在于assetManager.addAssetPath(String apkfilePath)此方法。</div>
<div></div>
<div>现在要做的就是使用反射机制实现上面的隐藏api。</div>
<div>具体反射实现代码如下：</div>
<div></div>
<div>
<div>
<pre class="brush:java">Class asm_cls = Class.forName(&ldquo;android.content.res.AssetManager&rdquo;);
Object asm_obj = asm_cls.getDeclaredConstructor((Class[]) null).newInstance((Class[]) null);
asm_obj.getClass()  .getDeclaredMethod(&ldquo;addAssetPath&rdquo;, new Class[] { String.class })
                .invoke(asm_obj, new Object[] { filePath });
Resources res=getResources();
res = Resources.class.getDeclaredConstructor(
                new Class[] { asm_obj.getClass(),
                        res.getDisplayMetrics().getClass(),
                        res.getConfiguration().getClass() })
    .newInstance(new Object[] { asm_obj,
                                                    res.getDisplayMetrics(),
                            res.getConfiguration() });
return res;</pre>
</div>
<div></div>
</div>
<div></div>
<div></div>
<div>res.getString(applicaiontInfo.labelRes);</div>
<div>res.getDrawable(applicationInfo.icon);</div></p>
</section>
                        <aside class="aside clearfix">
                            <a class="btn btn-primary btn-lg pull-right" href="/2012/2/21/resolve_apk_file_reource.html">继续阅读</a>
                        </aside>
                    </div>
                </div>
            </article>
            
            <article class="article">
                <div class="row">
                    <div class="col-md-10 col-md-offset-1 panel panel-default">
                        <header class="header">
                            <div class="meta">
                        <span class="date">
                            <span class="month">2</span>
                            <span class="day">19</span>
                        </span>
                            </div>
                            <h3 class="title">
                                <a href="/2012/2/19/android_screen_shot.html">ANDROID应用内截图的代码实现</a>
                            </h3>
                        </header>
                        <section class="brief"><p>方法一：</p>

<p>View view= getWindow().getDecorView();</p>

<p>Bitmap bmp = Bitmap.createBitmap(480, 800, Bitmap.Config.ARGB_8888);</p>

<p>view.draw(new Canvas(b));</p>

<p>bmp就是截取的图片了，可通过bmp.compress(CompressFormat.PNG, 100, new FileOutputStream(file));把图片保存为文件。</p>

<p>&nbsp;</p>

<p>方法二：</p>

<p>getWindow().getDecorView().setDrawingCacheEnabled(true);</p>

<p>bmp=getWindow().getDecorView().getDrawingCache();</p>

<p>&nbsp;</p>

<p>但这样得到的图片是包含状态栏和标题栏的，如果想把状态栏和标题栏去掉，可把得到的图片顶部一部分剪裁掉。</p>

<p>1、得到状态栏高度</p>

<p>Rect rect = new Rect();</p>

<p>view.getWindowVisibleDisplayFrame(rect);</p>

<p>int statusBarHeight = rect.top;</p>

<p>System.out.println(&ldquo;状态栏高度：&rdquo; + statusBarHeight);</p>

<p>&nbsp;</p>

<p>2、得到标题栏高度</p>

<p>int wintop = getWindow().findViewById(android.R.id.content).getTop();</p>

<p>int titleBarHeight = wintop - statusBarHeight;</p>

<p>System.out.println(&ldquo;标题栏高度:&rdquo; + titleBarHeight);</p>

<p>&nbsp;</p>

<p>&nbsp;</p>

<p>注：这样得到的截图是不会包含dialog和popupwindow的，你必须单独得到popupwindow的截图，然后再和背景截图合到一起。</p>

<p>另外，截图的相关代码是不能放到oncreate中的，因为这时候getDectorView()得到的是null</p>

<p>&nbsp;</p>

<p>&nbsp;</p>

<p>把两个bitmap合到一起的方法很简单。</p>

<p>Bitmap bmpall=Biatmap.createBitmap(width,height,Config.ARGB_8888);</p>

<p>Canvas canvas=new Canvas(bmpall);</p>

<p>canvas.drawBitmap(bmp1,x,y,paint);</p>

<p>canvas.drawBitmap(bmp2,x,y,paint);</p>

<p>得到的bmpall就是合在一起的图片了。</p>

<p>&nbsp;</p>

<p>ps:按理说也getWindow.findViewById(android.R.id.content)得到的view就是不包含状态栏和标题栏的view，但这个我还没有试过。</p>
</section>
                        <aside class="aside clearfix">
                            <a class="btn btn-primary btn-lg pull-right" href="/2012/2/19/android_screen_shot.html">继续阅读</a>
                        </aside>
                    </div>
                </div>
            </article>
            
            <article class="article">
                <div class="row">
                    <div class="col-md-10 col-md-offset-1 panel panel-default">
                        <header class="header">
                            <div class="meta">
                        <span class="date">
                            <span class="month">10</span>
                            <span class="day">25</span>
                        </span>
                            </div>
                            <h3 class="title">
                                <a href="/2011/10/25/android_secrect_code.html">监听android的拨号事件(android secret code)</a>
                            </h3>
                        </header>
                        <section class="brief"><p>这是个比较冷门的东西，简单的说就是当你在拨号盘输入<em>#</em>#xxxx#*#*的时候接到通知，然后可以进行相关操作。</p>

<p>首先能想到的应用就是私密类程序。比如你的程序是没有图标的，用户输入这些暗号后可以进行一些操作，或者进入软件界面。</p>

<p>原理很简单，其实也是一个broastcastReceiver而已，只是action并没有放到Intent的常量中，所以很少有人知道。</p>
</section>
                        <aside class="aside clearfix">
                            <a class="btn btn-primary btn-lg pull-right" href="/2011/10/25/android_secrect_code.html">继续阅读</a>
                        </aside>
                    </div>
                </div>
            </article>
            
            <article class="article">
                <div class="row">
                    <div class="col-md-10 col-md-offset-1 panel panel-default">
                        <header class="header">
                            <div class="meta">
                        <span class="date">
                            <span class="month">9</span>
                            <span class="day">3</span>
                        </span>
                            </div>
                            <h3 class="title">
                                <a href="/2011/9/3/android_musicplayer_widget.html">Android音乐播放widget的简单事例(附源代码)</a>
                            </h3>
                        </header>
                        <section class="brief"><p>本文将做一个音乐播放的appWidget。通过本文您将学会：</p>

<p>1.制作简单的appWidget</p>

<p>2.service、broadcast</p>

<p>3.service与appWidget的交互</p>

<p>4.通过第三方库来读取mp3文件的id3标签(歌曲名、歌手名、专辑名等)</p>

<p><a href="http://veikr.com/wp-content/uploads/2011/09/musicWidget.png"><img class="aligncenter size-full wp-image-238" title="音乐播放器的AppWidget" src="http://veikr.com/wp-content/uploads/2011/09/device.png" alt="音乐播放器的AppWidget效果图" width="480" height="230" /></a></p>
</section>
                        <aside class="aside clearfix">
                            <a class="btn btn-primary btn-lg pull-right" href="/2011/9/3/android_musicplayer_widget.html">继续阅读</a>
                        </aside>
                    </div>
                </div>
            </article>
            
            <article class="article">
                <div class="row">
                    <div class="col-md-10 col-md-offset-1 panel panel-default">
                        <header class="header">
                            <div class="meta">
                        <span class="date">
                            <span class="month">6</span>
                            <span class="day">13</span>
                        </span>
                            </div>
                            <h3 class="title">
                                <a href="/2011/6/13/android_webview_content-html.html">android中如何获得webView中的内容</a>
                            </h3>
                        </header>
                        <section class="brief"><p>本文概要：在程序中经常会用到webView来显示网页，但如果能够得到网页中的内容呢，本文将给你一个最简单的事例。文章最后附代码下载。</p>

<p>在做新浪微博客户端的时候需要用到oauth认证，会弹出新浪的认证网页，用户在新浪的网页中授权后返回到程序中完成认证。使用的是类似weibo://OauthActivity这样的URI返回的，也就类似于<a href="http://weibo.com">http://weibo.com</a>这样。但是UC浏览器却无法完成这个地址的跳转，android自带浏览器是没有问题的，所以就想到在程序中内嵌一个webView去显示新浪的网页进行授权。</p>
</section>
                        <aside class="aside clearfix">
                            <a class="btn btn-primary btn-lg pull-right" href="/2011/6/13/android_webview_content-html.html">继续阅读</a>
                        </aside>
                    </div>
                </div>
            </article>
            
            <div class="article-pager text-center">
                
                
            </div>
        </div>
    </div>
</section>
<footer id="footer">
    <div class="container text-center">
        <p>© 2015 veikr的博客.
            <a href="http://creativecommons.org/licenses/by/3.0/">Some rights reserved </a> |
            <a href="/feed.xml">Feed</a> |
            <a href="/sitemap.xml">Sitemap</a>
        </p>
        <p>Powered by <a href="https://github.com/go-xiaohei/pugo">PuGo 0.10.5 (beta)</a>. Theme by Default.
        </p>
        <p>Hosted by <a href="https://pages.coding.me" style="font-weight: bold">Coding Pages</a></p>
        
    
    

    </div>
</footer>
<script src="/js/jquery-2.1.4.min.js"></script>
<script src="/js/bootstrap.min.js"></script>
<script src="/js/prism.min.js"></script>
<script>
    $(document).ready(function () {
        $("pre code").addClass("line-numbers")
    });
</script>
</body>
</html>
